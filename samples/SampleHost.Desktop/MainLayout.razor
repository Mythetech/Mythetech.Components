@namespace SampleHost.Desktop
@using MudBlazor
@using Mythetech.Framework.Infrastructure.Files
@using Mythetech.Framework.Infrastructure.Plugins
@using Mythetech.Framework.Infrastructure.Plugins.Components
@using SampleHost.Shared
@inherits LayoutComponentBase
@inject PluginState PluginState
@inject IPluginAssetLoader AssetLoader
@inject IShowFileService ShowFileService
@implements IDisposable

<MudLayout>
    <MudAppBar Elevation="1">
        <MudText Typo="Typo.h5" Class="ml-3">Plugin Host Sample</MudText>
        <MudSpacer />
        
        <MudMenu Label="File" ListClass="pa-1" Class="rounded" ActivationEvent="MouseEvent.MouseOver" Dense="true">
            <MudMenuItem OnClick="@OpenPluginDirectory" Disabled="@(string.IsNullOrEmpty(PluginState.PluginDirectory))">
                Open Plugin Directory
            </MudMenuItem>
        </MudMenu>
        
        <!-- Standard Plugin Menu with nested plugin actions -->
        <StandardPluginMenu MenuText="Plugins"
                           ListClass="pa-1"
                           ItemClass="rounded"
                           ButtonClass="text-transform-none" />
        
        <ToolsMenu />

        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Inherit" />
    </MudAppBar>
    
    <MudDrawer @bind-Open="_drawerOpen" Elevation="2" Variant="DrawerVariant.Mini" OpenMiniOnHover="true">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">Plugins</MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
            <MudNavLink Href="/plugins" Icon="@Icons.Material.Filled.Extension">Manage Plugins</MudNavLink>
        </MudNavMenu>
    </MudDrawer>
    
    <MudMainContent Class="d-flex" Style="height: calc(100vh - 64px);">
        <div class="flex-grow-1 pa-4" style="overflow: auto;">
            @Body
        </div>
        
        <!-- Plugin context panels rendered as a side bar (only after assets are loaded) -->
        @if (_assetsLoaded && PluginState.EnabledContextPanelComponentsMetadata.Any())
        {
            <MudPaper Width="320px" Elevation="0" Class="border-l" Style="overflow: auto;">
                @foreach (var panel in PluginState.EnabledContextPanelComponentsMetadata.OrderBy(p => p.Order))
                {
                    <DynamicComponent Type="@panel.ComponentType" />
                    <MudDivider />
                }
            </MudPaper>
        }
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _assetsLoaded = false;

    protected override void OnInitialized()
    {
        PluginState.StateChanged += OnPluginStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || !_assetsLoaded)
        {
            await LoadAllPluginAssetsAsync();
            _assetsLoaded = true;
            StateHasChanged();
        }
    }

    private async Task LoadAllPluginAssetsAsync()
    {
        foreach (var plugin in PluginState.EnabledPlugins)
        {
            await AssetLoader.LoadPluginAssetsAsync(plugin);
        }
    }

    private void OnPluginStateChanged(object? sender, EventArgs e)
    {
        _assetsLoaded = false;
        InvokeAsync(StateHasChanged);
    }

    private async Task OpenPluginDirectory()
    {
        if (!string.IsNullOrEmpty(PluginState.PluginDirectory))
        {
            await ShowFileService.ShowFolderAsync(PluginState.PluginDirectory);
        }
    }

    public void Dispose()
    {
        PluginState.StateChanged -= OnPluginStateChanged;
    }
}
