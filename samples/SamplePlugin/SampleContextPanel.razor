@using MudBlazor
@using Mythetech.Framework.Infrastructure.Plugins.Components
@attribute [PluginComponentMetadata(
    Icon = Icons.Material.Filled.Dashboard,
    Title = "Sample Panel",
    Order = 10)]
@inherits PluginContextPanel
@implements Mythetech.Framework.Infrastructure.MessageBus.IConsumer<SamplePluginMessage>

<MudPaper Class="pa-4 sample-plugin-loaded" Elevation="0">
    <MudText Typo="Typo.h6" Class="mb-3 sample-plugin-badge">
        <MudIcon Icon="@Icon" Class="mr-2" />
        @Title
    </MudText>
    
    <MudText Typo="Typo.body2" Class="mb-4">
        This panel demonstrates a context panel plugin component. 
        It can display information, controls, or other UI elements alongside the main content.
    </MudText>
    
    <MudDivider Class="mb-4" />
    
    <MudText Typo="Typo.subtitle2" Class="mb-2">Shared Plugin State</MudText>
    <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
        <tbody>
            <tr>
                <td><strong>Status</strong></td>
                <td><MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip></td>
            </tr>
            <tr>
                <td><strong>Messages Sent (shared)</strong></td>
                <td>@MessageCount</td>
            </tr>
            <tr>
                <td><strong>Last Message</strong></td>
                <td>@(LastMessage ?? "None")</td>
            </tr>
        </tbody>
    </MudSimpleTable>
    
    <MudButton Variant="Variant.Outlined" 
               Color="Color.Primary" 
               FullWidth="true" 
               OnClick="PublishTestEvent">
        Publish Event from Panel
    </MudButton>
</MudPaper>

@code {
    public override string Icon => Icons.Material.Filled.Dashboard;
    public override string Title => "Sample Panel";
    public override int Order => 10;
    
    private int MessageCount => GetState<int>("messageCount");
    private string? LastMessage => GetState<string>("lastMessage");
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        MessageBus.Subscribe(this);
    }
    
    private async Task PublishTestEvent()
    {
        var count = GetState<int>("messageCount") + 1;
        var message = $"Event published at {DateTime.Now:HH:mm:ss}";
        
        SetState(count, "messageCount");
        SetState(message, "lastMessage");
        
        await PublishAsync(new SamplePluginMessage(message));
    }

    public Task Consume(SamplePluginMessage message)
    {
        SetState(message.Text, "lastMessage");
        return Task.CompletedTask;
    }

    public override void Dispose()
    {
        MessageBus.Unsubscribe(this);
        base.Dispose();
    }
}
