@using Mythetech.Framework.Infrastructure
@using Mythetech.Framework.Components.Buttons
@using Mythetech.Framework.WebAssembly.Exceptions
@attribute [Stories("Infrastructure/FileServices")]

<Stories TComponent="IFileOpenService">

    <Story TComponent="IFileOpenService" Layout="typeof(DefaultMudLayout)" Name="File Operations">
        <Template>
            <MudStack Class="mud-height-full pa-4" Style="min-height:50dvh;">
                <MudText Typo="Typo.h5">File Services Demo</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    Demonstrates the IFileOpenService and IFileSaveService abstractions with error handling
                </MudText>
                
                <MudDivider Class="my-2" />
                
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudText Typo="Typo.h6" Class="mb-3">Open Files</MudText>
                            
                            <MudStack Spacing="2">
                                <Button Text="Open Single File" 
                                        Variant="Variant.Filled" 
                                        Color="Color.Primary"
                                        OnClick="@OpenSingleFile" />
                                        
                                <Button Text="Open Multiple Files" 
                                        Variant="Variant.Outlined" 
                                        Color="Color.Primary"
                                        OnClick="@OpenMultipleFiles" />
                                        
                                <Button Text="Open with Filter (Images)" 
                                        Variant="Variant.Outlined" 
                                        Color="Color.Secondary"
                                        OnClick="@OpenWithFilter" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudText Typo="Typo.h6" Class="mb-3">Open Folder</MudText>
                            
                            <MudStack Spacing="2">
                                <Button Text="Select Folder" 
                                        Variant="Variant.Filled" 
                                        Color="Color.Tertiary"
                                        OnClick="@OpenFolder" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudText Typo="Typo.h6" Class="mb-3">Save File</MudText>
                            
                            <MudStack Spacing="2">
                                <MudTextField @bind-Value="_saveFileName" 
                                              Label="File Name" 
                                              Variant="Variant.Outlined" />
                                              
                                <MudTextField @bind-Value="_saveContent" 
                                              Label="Content" 
                                              Variant="Variant.Outlined"
                                              Lines="3" />
                                              
                                <Button Text="Save File" 
                                        Variant="Variant.Filled" 
                                        Color="Color.Success"
                                        OnClick="@SaveFile" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
                
                @if (_selectedPaths.Length > 0)
                {
                    <MudPaper Class="pa-4 mt-4" Elevation="1">
                        <MudText Typo="Typo.subtitle1" Class="mb-2">Selected Items:</MudText>
                        <MudList T="string" Dense="true">
                            @foreach (var path in _selectedPaths)
                            {
                                <MudListItem T="string" Icon="@Icons.Material.Filled.InsertDriveFile">
                                    @path
                                </MudListItem>
                            }
                        </MudList>
                    </MudPaper>
                }
                
                @if (!string.IsNullOrEmpty(_savedFileName))
                {
                    <MudAlert Severity="Severity.Success" Class="mt-4">
                        File saved as: @_savedFileName
                    </MudAlert>
                }
                
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-4" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)">
                        @_errorMessage
                    </MudAlert>
                }
                
                <MudDivider Class="my-4" />
                
                <MudMarkdown Value="@_explanationMarkdown" CodeBlockTheme="CodeBlockTheme.Dark" />
            </MudStack>
        </Template>
    </Story>
</Stories>

@code {
    [Inject]
    protected IFileOpenService FileOpenService { get; set; } = default!;
    
    [Inject]
    protected IFileSaveService FileSaveService { get; set; } = default!;
    
    [Inject]
    protected ISnackbar Snackbar { get; set; } = default!;
    
    private string[] _selectedPaths = [];
    private string? _errorMessage;
    private string? _savedFileName;
    private string _saveFileName = "example.txt";
    private string _saveContent = "Hello, World!";

    private async Task OpenSingleFile()
    {
        await ExecuteWithErrorHandling(async () =>
        {
            _selectedPaths = await FileOpenService.OpenFileAsync("Select a file");
            
            if (_selectedPaths.Length > 0)
                Snackbar.Add($"Selected: {_selectedPaths[0]}", Severity.Success);
            else
                Snackbar.Add("Selection cancelled", Severity.Info);
        });
    }

    private async Task OpenMultipleFiles()
    {
        await ExecuteWithErrorHandling(async () =>
        {
            _selectedPaths = await FileOpenService.OpenFileAsync(
                title: "Select multiple files",
                multiSelect: true);
            
            if (_selectedPaths.Length > 0)
                Snackbar.Add($"Selected {_selectedPaths.Length} file(s)", Severity.Success);
            else
                Snackbar.Add("Selection cancelled", Severity.Info);
        });
    }

    private async Task OpenWithFilter()
    {
        await ExecuteWithErrorHandling(async () =>
        {
            var filters = new[]
            {
                new FileFilter("Images", ["png", "jpg", "jpeg", "gif", "webp"]),
                new FileFilter("All Files", ["*"])
            };
            
            _selectedPaths = await FileOpenService.OpenFileAsync(
                title: "Select an image",
                filters: filters);
            
            if (_selectedPaths.Length > 0)
                Snackbar.Add($"Selected: {_selectedPaths[0]}", Severity.Success);
            else
                Snackbar.Add("Selection cancelled", Severity.Info);
        });
    }

    private async Task OpenFolder()
    {
        await ExecuteWithErrorHandling(async () =>
        {
            _selectedPaths = await FileOpenService.OpenFolderAsync("Select a folder");
            
            if (_selectedPaths.Length > 0)
                Snackbar.Add($"Selected folder: {_selectedPaths[0]}", Severity.Success);
            else
                Snackbar.Add("Selection cancelled", Severity.Info);
        });
    }

    private async Task SaveFile()
    {
        _savedFileName = null;
        
        await ExecuteWithErrorHandling(async () =>
        {
            var result = await FileSaveService.SaveFileAsync(_saveFileName, _saveContent);
            
            if (result)
            {
                _savedFileName = _saveFileName;
                Snackbar.Add($"File saved successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add("Save cancelled", Severity.Info);
            }
        });
    }

    private async Task ExecuteWithErrorHandling(Func<Task> action)
    {
        _errorMessage = null;
        _selectedPaths = [];
        _savedFileName = null;
        
        try
        {
            await action();
        }
        catch (UnsupportedBrowserApiException ex)
        {
            _errorMessage = $"Browser does not support the {ex.ApiName} API. Try using Chrome, Edge, or another Chromium-based browser.";
            Snackbar.Add("Browser API not supported", Severity.Error);
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
            Snackbar.Add("Operation failed", Severity.Error);
        }
        
        StateHasChanged();
    }

    private string _explanationMarkdown = @"
## File Services

The `IFileOpenService` and `IFileSaveService` provide platform-agnostic ways to open and save files. They have different implementations for WebAssembly and Desktop (Photino).

### Opening Files

```csharp
// Single file
var files = await FileOpenService.OpenFileAsync(""Select a file"");

// Multiple files
var files = await FileOpenService.OpenFileAsync(
    title: ""Select files"",
    multiSelect: true);

// With filters
var filters = new[]
{
    new FileFilter(""Images"", [""png"", ""jpg"", ""gif""]),
    new FileFilter(""All Files"", [""*""])
};
var files = await FileOpenService.OpenFileAsync(filters: filters);
```

### Opening Folders

```csharp
var folders = await FileOpenService.OpenFolderAsync(""Select a folder"");
```

### Saving Files

```csharp
// Prompt and save
var success = await FileSaveService.SaveFileAsync(""myfile.txt"", ""content"");

// Just get the save location
var path = await FileSaveService.PromptFileSaveAsync(""myfile"", ""txt"");
```

### Error Handling

In WebAssembly, the File System Access API may not be supported in all browsers. Wrap calls in a try-catch to handle `UnsupportedBrowserApiException`:

```csharp
try
{
    var files = await FileOpenService.OpenFileAsync();
}
catch (UnsupportedBrowserApiException ex)
{
    // Show user-friendly message
    Console.WriteLine($""{ex.ApiName} is not supported"");
}
```

### Registration

**WebAssembly:**
```csharp
builder.Services.AddFileOpenService();
builder.Services.AddFileSaveService();
// or register all WebAssembly services
builder.Services.AddWebAssemblyServices();
```

**Desktop (Photino):**
```csharp
builder.Services.AddPhotinoServices();
```
";
}
