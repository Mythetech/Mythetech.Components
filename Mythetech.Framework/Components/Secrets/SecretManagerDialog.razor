@using MudBlazor
@using Mythetech.Framework.Infrastructure.Secrets
@using Mythetech.Framework.Components.Badge
@inject SecretManagerState SecretManagerState
@implements IDisposable

<MudDialog>
    <DialogContent>
        <MudStack Spacing="4">
            <MudText Typo="Typo.h6">Secret Manager</MudText>
            
            <MudDivider />
            
            <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="RefreshSecrets"
                          Disabled="_isRefreshing">
                    Refresh
                </MudButton>
                
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Info" 
                          StartIcon="@Icons.Material.Filled.CheckCircle"
                          OnClick="TestConnection"
                          Disabled="_isTesting">
                    Test Connection
                </MudButton>
                
                <MudSpacer />
                
                <MudTextField 
                    T="string"
                    Value="_searchTerm"
                              ValueChanged="@OnSearchTermChanged"
                              Placeholder="Search secrets..."
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              Style="max-width: 300px;" />
            </MudStack>
            
            @if (_isRefreshing || _isTesting)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            
            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <MudAlert Severity="@_alertSeverity" Dense="true">@_statusMessage</MudAlert>
            }
            
            @if (!SecretManagerState.IsAvailable)
            {
                <MudAlert Severity="Severity.Warning" Dense="true">
                    Secret manager is not available or not configured.
                </MudAlert>
            }
            
            <MudDivider />
            
            @if (_filteredSecrets.Any())
            {
                <MudList T="Secret" Dense="true">
                    @foreach (var secret in _filteredSecrets)
                    {
                        <MudListItem T="Secret">
                            <MudStack Spacing="1">
                                <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                        @(secret.Name ?? secret.Key)
                                    </MudText>
                                    @if (!string.IsNullOrEmpty(secret.Category))
                                    {
                                        <Badge Size="Size.Small" Color="Color.Secondary" Variant="Variant.Text">
                                            @secret.Category
                                        </Badge>
                                    }
                                </MudStack>
                                
                                @if (!string.IsNullOrEmpty(secret.Description))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        @secret.Description
                                    </MudText>
                                }
                                
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Key: @secret.Key
                                </MudText>
                                
                                @if (secret.Tags != null && secret.Tags.Length > 0)
                                {
                                    <MudStack Row Spacing="1">
                                        @foreach (var tag in secret.Tags)
                                        {
                                            <Badge Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                                                @tag
                                            </Badge>
                                        }
                                    </MudStack>
                                }
                                
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Value: @(new string('*', Math.Min(secret.Value?.Length ?? 0, 20)))
                                </MudText>
                            </MudStack>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            }
            else if (!_isRefreshing)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                    @(string.IsNullOrWhiteSpace(_searchTerm) ? "No secrets found. Click Refresh to load secrets." : "No secrets match your search.")
                </MudText>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }
    
    private string _searchTerm = string.Empty;
    private bool _isRefreshing;
    private bool _isTesting;
    private string? _statusMessage;
    private Severity _alertSeverity = Severity.Info;
    
    private IEnumerable<Secret> _filteredSecrets = [];
    
    protected override void OnInitialized()
    {
        SecretManagerState.StateChanged += OnStateChanged;
        LoadSecrets();
    }
    
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _ = RefreshSecrets();
        }
    }
    
    private void OnStateChanged(object? sender, EventArgs e)
    {
        InvokeAsync(() =>
        {
            LoadSecrets();
            StateHasChanged();
        });
    }
    
    private void OnSearchTermChanged(string? newValue)
    {
        _searchTerm = newValue ?? string.Empty;
        LoadSecrets();
        StateHasChanged();
    }
    
    private void LoadSecrets()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            _filteredSecrets = SecretManagerState.Secrets;
        }
        else
        {
            var term = _searchTerm.ToLowerInvariant();
            _filteredSecrets = SecretManagerState.Secrets.Where(s =>
                s.Key.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (s.Name?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (s.Description?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (s.Tags?.Any(t => t.Contains(term, StringComparison.OrdinalIgnoreCase)) ?? false) ||
                (s.Category?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false)
            );
        }
    }
    
    private async Task RefreshSecrets()
    {
        _isRefreshing = true;
        _statusMessage = null;
        StateHasChanged();
        
        try
        {
            await SecretManagerState.RefreshSecretsAsync();
            _statusMessage = $"Loaded {SecretManagerState.Secrets.Count} secret(s)";
            _alertSeverity = Severity.Success;
            LoadSecrets();
        }
        catch (Exception ex)
        {
            _statusMessage = $"Failed to refresh secrets: {ex.Message}";
            _alertSeverity = Severity.Error;
        }
        finally
        {
            _isRefreshing = false;
            StateHasChanged();
        }
    }
    
    private async Task TestConnection()
    {
        _isTesting = true;
        _statusMessage = null;
        StateHasChanged();
        
        try
        {
            if (SecretManagerState.CurrentManager != null)
            {
                var isAvailable = await SecretManagerState.CurrentManager.TestConnectionAsync();
                _statusMessage = isAvailable 
                    ? "Connection test successful" 
                    : "Connection test failed - secret manager is not available";
                _alertSeverity = isAvailable ? Severity.Success : Severity.Error;
            }
            else
            {
                _statusMessage = "No secret manager is registered";
                _alertSeverity = Severity.Warning;
            }
        }
        catch (Exception ex)
        {
            _statusMessage = $"Connection test failed: {ex.Message}";
            _alertSeverity = Severity.Error;
        }
        finally
        {
            _isTesting = false;
            StateHasChanged();
        }
    }
    
    private void Close()
    {
        MudDialog?.Close();
    }
    
    public void Dispose()
    {
        SecretManagerState.StateChanged -= OnStateChanged;
    }
}

